CREATE PROCEDURE [dbo].[CALCULA_SALARIO_FUNC]
@CPF CHAR(11),
@MES INT,
@ANO INT
AS
	BEGIN 
		DECLARE @VENDA_CARRO FLOAT;
		DECLARE @VENDA_SEG FLOAT;
		DECLARE @VAL_TOT FLOAT;
		DECLARE @SAL_FIX FLOAT;
		DECLARE @MESCONTR INT;
		DECLARE @ANOCONTR INT;

		SET @MESCONTR = (SELECT MONTH(DTA_CONTRATACAO) FROM FUNCIONARIO WHERE NUM_CPF = @CPF);
		SET @ANOCONTR = (SELECT YEAR(DTA_CONTRATACAO) FROM FUNCIONARIO WHERE NUM_CPF = @CPF);

		IF (@MESCONTR < @MES) AND (@ANOCONTR < @ANO)
		BEGIN
			RETURN 0
		END

		SET @SAL_FIX = (SELECT VAL_SALARIO FROM FUNCIONARIO_SALARIO
		WHERE NUM_CPF_FUNCIONARIO = @CPF AND MONTH(DTA_INICIO) = @MES AND YEAR(DTA_INICIO) = @ANO);

		IF @SAL_FIX > 0.00
		BEGIN
			SET @VENDA_CARRO = (SELECT SUM(AUT.VAL_PRECO) FROM AUTOMOVEL AUT
			JOIN FUNCIONARIO_VENDA_AUTO FVA ON FVA.DES_CHASSI = AUT.DES_CHASSI
			JOIN FUNCIONARIO F ON F.NUM_CPF = FVA.NUM_CPF_FUNCIONARIO
			WHERE F.NUM_CPF = @CPF AND MONTH(FVA.DTA_VENDA) = @MES AND YEAR(FVA.DTA_VENDA) = @ANO);

			SET @VENDA_SEG = (SELECT SUM(SEG.VAL_PRECO) FROM SEGURO SEG
			JOIN SEGURO_AUTOMOVEL SEGAUTO ON SEGAUTO.ID_SEGURO = SEG.ID_SEGURO
			JOIN FUNCIONARIO F ON F.NUM_CPF = SEGAUTO.NUM_CPF_FUNCIONARIO
			WHERE SEGAUTO.NUM_CPF_FUNCIONARIO = @CPF AND MONTH(SEGAUTO.DTA_CONTRATO) = @MES AND YEAR(SEGAUTO.DTA_CONTRATO) = @ANO);

			SET @VAL_TOT = @SAL_FIX;

			IF @VENDA_SEG > 0 
			BEGIN
				SET @VAL_TOT += (0.05*@VENDA_SEG); 
			END
			IF @VENDA_CARRO > 0
			BEGIN
				SET @VAL_TOT += (0.1*@VENDA_CARRO);
			END

			RETURN @VAL_TOT;
		END
		ELSE
		BEGIN
			RETURN 0
		END
	END